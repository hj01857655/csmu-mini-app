<template>
	<view class="container">
		<!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
		<view class="user-card">
			<view class="avatar-section">
				<image class="avatar" src="/static/avatar.png" mode="aspectFill"></image>
				<view class="user-info">
					<view class="username">{{ userInfo.name }}</view>
					<view class="student-id">å­¦å·ï¼š{{ userInfo.studentId }}</view>
					<view class="major">{{ userInfo.major }} Â· {{ userInfo.grade }}</view>
					<view class="class-info">{{ userInfo.className }} Â· {{ userInfo.college }}</view>
				</view>
			</view>
			<view class="user-stats">
				<view class="stat-item">
					<view class="stat-value">{{ userInfo.totalCredits }}</view>
					<view class="stat-label">æ€»å­¦åˆ†</view>
				</view>
				<view class="stat-item">
					<view class="stat-value">{{ userInfo.gpa }}</view>
					<view class="stat-label">å¹³å‡ç»©ç‚¹</view>
				</view>
				<view class="stat-item">
					<view class="stat-value">{{ userInfo.rank }}</view>
					<view class="stat-label">ä¸“ä¸šæ’å</view>
				</view>
			</view>
		</view>

		<!-- åŠŸèƒ½èœå• -->
		<view class="menu-section">
			<view class="menu-group">
				<view class="group-title">ä¸ªäººä¿¡æ¯</view>
				<view class="menu-item" @click="navigateToPage('/pages/profile-detail/profile-detail')">
					<view class="menu-icon info-icon">ğŸ‘¤</view>
					<view class="menu-content">
						<view class="menu-title">ä¸ªäººèµ„æ–™</view>
						<view class="menu-desc">æŸ¥çœ‹å’Œç¼–è¾‘ä¸ªäººä¿¡æ¯</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="navigateToPage('/pages/change-password/change-password')">
					<view class="menu-icon password-icon">ğŸ”’</view>
					<view class="menu-content">
						<view class="menu-title">ä¿®æ”¹å¯†ç </view>
						<view class="menu-desc">æ›´æ”¹ç™»å½•å¯†ç </view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="navigateToPage('/pages/semester-info/semester-info')">
					<view class="menu-icon semester-icon">ğŸ“…</view>
					<view class="menu-content">
						<view class="menu-title">å­¦æœŸä¿¡æ¯</view>
						<view class="menu-desc">æŸ¥çœ‹å­¦æœŸå’Œå‘¨æ¬¡ä¿¡æ¯</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
			</view>

			<view class="menu-group">
				<view class="group-title">å­¦ä¹ å·¥å…·</view>
				<view class="menu-item" @click="navigateToPage('/pages/grades/grades')">
					<view class="menu-icon grade-icon">ğŸ“Š</view>
					<view class="menu-content">
						<view class="menu-title">æˆç»©æŸ¥è¯¢</view>
						<view class="menu-desc">æŸ¥çœ‹å„ç§‘æˆç»©è¯¦æƒ…</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="navigateToPage('/pages/exam/exam')">
					<view class="menu-icon exam-icon">ğŸ“</view>
					<view class="menu-content">
						<view class="menu-title">è€ƒè¯•å®‰æ’</view>
						<view class="menu-desc">æŸ¥çœ‹è€ƒè¯•æ—¶é—´åœ°ç‚¹</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="navigateToPage('/pages/course-selection/course-selection')">
					<view class="menu-icon course-icon">ğŸ“š</view>
					<view class="menu-content">
						<view class="menu-title">é€‰è¯¾ç³»ç»Ÿ</view>
						<view class="menu-desc">åœ¨çº¿é€‰è¯¾é€€è¯¾</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="navigateToPage('/pages/evaluation/evaluation')">
					<view class="menu-icon evaluation-icon">â­</view>
					<view class="menu-content">
						<view class="menu-title">æ•™å­¦è¯„ä»·</view>
						<view class="menu-desc">è¯¾ç¨‹å’Œæ•™å¸ˆè¯„ä»·</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
			</view>

			<view class="menu-group">
				<view class="group-title">æ ¡å›­æœåŠ¡</view>
				<view class="menu-item" @click="navigateToPage('/pages/notices/notices')">
					<view class="menu-icon notice-icon">ğŸ“¢</view>
					<view class="menu-content">
						<view class="menu-title">æ ¡å›­é€šçŸ¥</view>
						<view class="menu-desc">æŸ¥çœ‹æœ€æ–°æ ¡å›­åŠ¨æ€</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="showFeatureInfo('å›¾ä¹¦é¦†')">
					<view class="menu-icon library-icon">ğŸ“š</view>
					<view class="menu-content">
						<view class="menu-title">å›¾ä¹¦é¦†</view>
						<view class="menu-desc">å›¾ä¹¦æŸ¥è¯¢ä¸å€Ÿé˜…</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="showFeatureInfo('æ ¡å›­å¡')">
					<view class="menu-icon card-icon">ğŸ’³</view>
					<view class="menu-content">
						<view class="menu-title">æ ¡å›­å¡</view>
						<view class="menu-desc">ä½™é¢æŸ¥è¯¢ä¸å……å€¼</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
			</view>

			<view class="menu-group">
				<view class="group-title">ç³»ç»Ÿè®¾ç½®</view>
				<view class="menu-item" @click="showFeatureInfo('ç³»ç»Ÿè®¾ç½®')">
					<view class="menu-icon setting-icon">âš™ï¸</view>
					<view class="menu-content">
						<view class="menu-title">ç³»ç»Ÿè®¾ç½®</view>
						<view class="menu-desc">ä¸ªæ€§åŒ–è®¾ç½®</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="showHelpInfo">
					<view class="menu-icon help-icon">â“</view>
					<view class="menu-content">
						<view class="menu-title">å¸®åŠ©åé¦ˆ</view>
						<view class="menu-desc">ä½¿ç”¨å¸®åŠ©ä¸é—®é¢˜åé¦ˆ</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
				<view class="menu-item" @click="logout">
					<view class="menu-icon logout-icon">ğŸšª</view>
					<view class="menu-content">
						<view class="menu-title">é€€å‡ºç™»å½•</view>
						<view class="menu-desc">å®‰å…¨é€€å‡ºç³»ç»Ÿ</view>
					</view>
					<view class="menu-arrow">></view>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
import authService from '../../services/auth.js';

export default {
	data() {
		return {
			userInfo: {
				name: 'å¼ ä¸‰',
				studentId: '2021001001',
				major: 'è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯',
				grade: '2021çº§',
				totalCredits: 45,
				gpa: '3.65',
				rank: '15/120'
			}
		}
	},
	onLoad() {
		this.checkLoginStatus();
		this.loadUserInfo();
	},
	methods: {
		checkLoginStatus() {
			if (!authService.isLoggedIn()) {
				console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
				uni.reLaunch({
					url: '/pages/login/login'
				});
			}
		},

		async loadUserInfo() {
			try {
				uni.showLoading({
					title: 'åŠ è½½ä¸­...',
					mask: true
				});

				const currentUser = authService.getCurrentUser();
				if (currentUser) {
					// æ ¹æ®åç«¯è¿”å›çš„ç”¨æˆ·ä¿¡æ¯ç»“æ„æ›´æ–°
					this.userInfo = {
						...this.userInfo,
						name: currentUser.real_name || 'æœªçŸ¥ç”¨æˆ·',
						studentId: currentUser.student_id || currentUser.education_username || currentUser.username || '',
						major: currentUser.major || 'æœªçŸ¥ä¸“ä¸š',
						grade: currentUser.grade ? `${currentUser.grade}çº§` : 'æœªçŸ¥å¹´çº§',
						className: currentUser.class_name || 'æœªçŸ¥ç­çº§',
						college: currentUser.college || 'æœªçŸ¥å­¦é™¢',
						phone: currentUser.phone || '',
						totalCredits: currentUser.total_credits || currentUser.completed_credits || 45,
						gpa: currentUser.gpa || '3.65',
						rank: currentUser.rank || '15/120'
					};
				}

				// å°è¯•ä»APIè·å–æœ€æ–°çš„ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
				try {
					const educationApi = (await import('../../services/education-api.js')).default;
					const response = await educationApi.getUserStats();
					if (response.success && response.data) {
						this.userInfo = {
							...this.userInfo,
							totalCredits: response.data.totalCredits || this.userInfo.totalCredits,
							gpa: response.data.gpa || this.userInfo.gpa,
							rank: response.data.rank || this.userInfo.rank
						};
					}
				} catch (apiError) {
					console.log('è·å–ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®:', apiError);
				}

			} catch (e) {
				console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
				uni.showToast({
					title: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
					icon: 'none'
				});
			} finally {
				uni.hideLoading();
			}
		},
		navigateTo(url) {
			uni.switchTab({
				url: url
			});
		},
		navigateToPage(url) {
			uni.navigateTo({
				url: url
			});
		},
		showFeatureInfo(featureName) {
			const featureInfos = {
				'å›¾ä¹¦é¦†': {
					title: 'å›¾ä¹¦é¦†æœåŠ¡',
					content: 'å›¾ä¹¦é¦†åŠŸèƒ½åŒ…æ‹¬ï¼š\nâ€¢ å›¾ä¹¦æ£€ç´¢ä¸é¢„çº¦\nâ€¢ å€Ÿé˜…è®°å½•æŸ¥è¯¢\nâ€¢ åº§ä½é¢„çº¦\nâ€¢ ç”µå­èµ„æºè®¿é—®\n\nè¯¥åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼'
				},
				'æ ¡å›­å¡': {
					title: 'æ ¡å›­å¡æœåŠ¡',
					content: 'æ ¡å›­å¡åŠŸèƒ½åŒ…æ‹¬ï¼š\nâ€¢ ä½™é¢æŸ¥è¯¢\nâ€¢ æ¶ˆè´¹è®°å½•\nâ€¢ åœ¨çº¿å……å€¼\nâ€¢ æŒ‚å¤±ä¸è§£æŒ‚\n\nè¯¥åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼'
				},
				'ç³»ç»Ÿè®¾ç½®': {
					title: 'ç³»ç»Ÿè®¾ç½®',
					content: 'ç³»ç»Ÿè®¾ç½®åŠŸèƒ½åŒ…æ‹¬ï¼š\nâ€¢ ä¸»é¢˜åˆ‡æ¢\nâ€¢ é€šçŸ¥è®¾ç½®\nâ€¢ éšç§è®¾ç½®\nâ€¢ ç¼“å­˜æ¸…ç†\n\nè¯¥åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ¨å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼'
				}
			};

			const info = featureInfos[featureName];
			if (info) {
				uni.showModal({
					title: info.title,
					content: info.content,
					showCancel: false,
					confirmText: 'æˆ‘çŸ¥é“äº†'
				});
			}
		},

		showHelpInfo() {
			uni.showModal({
				title: 'å¸®åŠ©ä¸åé¦ˆ',
				content: 'å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜æˆ–æœ‰å»ºè®®ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š\n\nğŸ“§ é‚®ç®±ï¼šsupport@csmu.edu.cn\nğŸ“ ç”µè¯ï¼š0731-12345678\nğŸ• æœåŠ¡æ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-17:00',
				showCancel: true,
				cancelText: 'å–æ¶ˆ',
				confirmText: 'è”ç³»å®¢æœ',
				success: (res) => {
					if (res.confirm) {
						uni.makePhoneCall({
							phoneNumber: '073112345678'
						});
					}
				}
			});
		},
		async logout() {
			uni.showModal({
				title: 'ç¡®è®¤é€€å‡º',
				content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
				success: async (res) => {
					if (res.confirm) {
						try {
							// ä½¿ç”¨è®¤è¯æœåŠ¡é€€å‡º
							await authService.logout();

							uni.showToast({
								title: 'é€€å‡ºæˆåŠŸ',
								icon: 'success',
								duration: 1500
							});
						} catch (error) {
							console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
							uni.showToast({
								title: 'é€€å‡ºå¤±è´¥',
								icon: 'none',
								duration: 2000
							});
						}
					}
				}
			});
		}
	}
}
</script>

<style scoped>
.container {
	background-color: var(--background-tertiary);
	min-height: 100vh;
}

.user-card {
	background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
	margin: var(--spacing-md);
	border-radius: var(--border-radius-lg);
	padding: var(--spacing-xl);
	color: white;
	box-shadow: var(--shadow-md);
}

.avatar-section {
	display: flex;
	align-items: center;
	margin-bottom: 30rpx;
}

.avatar {
	width: 120rpx;
	height: 120rpx;
	border-radius: 60rpx;
	margin-right: 30rpx;
	background-color: rgba(255,255,255,0.2);
}

.user-info {
	flex: 1;
}

.username {
	font-size: 36rpx;
	font-weight: bold;
	margin-bottom: 10rpx;
}

.student-id {
	font-size: 28rpx;
	opacity: 0.9;
	margin-bottom: 8rpx;
}

.major {
	font-size: 26rpx;
	opacity: 0.8;
	margin-bottom: 6rpx;
}

.class-info {
	font-size: 24rpx;
	opacity: 0.7;
}

.user-stats {
	display: flex;
	justify-content: space-around;
	background-color: rgba(255,255,255,0.1);
	border-radius: 16rpx;
	padding: 30rpx;
}

.stat-item {
	text-align: center;
}

.stat-value {
	font-size: 32rpx;
	font-weight: bold;
	margin-bottom: 8rpx;
}

.stat-label {
	font-size: 24rpx;
	opacity: 0.8;
}

.menu-section {
	margin: 20rpx;
}

.menu-group {
	background-color: #fff;
	border-radius: 16rpx;
	margin-bottom: 20rpx;
	overflow: hidden;
}

.group-title {
	padding: 30rpx;
	font-size: 28rpx;
	font-weight: bold;
	color: #333;
	background-color: #f8f9fa;
	border-bottom: 1rpx solid #e9ecef;
}

.menu-item {
	display: flex;
	align-items: center;
	padding: 30rpx;
	border-bottom: 1rpx solid #f0f0f0;
}

.menu-item:last-child {
	border-bottom: none;
}

.menu-icon {
	width: 80rpx;
	height: 80rpx;
	border-radius: 16rpx;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 36rpx;
	margin-right: 24rpx;
}

.info-icon { background-color: #e3f2fd; }
.password-icon { background-color: #ffebee; }
.home-icon { background-color: #e8f5e8; }
.schedule-icon { background-color: #e3f2fd; }
.grade-icon { background-color: #f3e5f5; }
.exam-icon { background-color: #fff3e0; }
.course-icon { background-color: #e1f5fe; }
.evaluation-icon { background-color: #fff8e1; }
.library-icon { background-color: #e8f5e8; }
.card-icon { background-color: #fce4ec; }
.notice-icon { background-color: #e0f2f1; }
.semester-icon { background-color: #fce4ec; }
.setting-icon { background-color: #f1f8e9; }
.help-icon { background-color: #fff8e1; }
.logout-icon { background-color: #ffebee; }

.menu-content {
	flex: 1;
}

.menu-title {
	font-size: 32rpx;
	color: #333;
	margin-bottom: 8rpx;
}

.menu-desc {
	font-size: 24rpx;
	color: #666;
}

.menu-arrow {
	font-size: 32rpx;
	color: #ccc;
}
</style>
