# 小程序登录功能集成说明

## 📋 概述

本文档说明了小程序前端如何与后端登录接口进行集成，实现教务系统账号直接登录功能。

## 🔧 更新内容

### 1. 新增服务模块

#### 认证服务 (`services/auth.js`)
- **教务系统登录**: 直接使用教务系统学号密码登录
- **Token管理**: 自动处理JWT Token的存储、刷新和过期
- **用户信息管理**: 统一管理用户信息的获取和存储

#### 配置管理 (`config/index.js`)
- **环境配置**: 开发、测试、生产环境的配置管理
- **API配置**: 统一管理API地址、超时时间等
- **功能开关**: 可配置的功能启用/禁用开关

### 2. 更新的页面

#### 登录页面 (`pages/login/login.vue`)
- **教务系统登录**: 使用教务系统学号密码登录
- **简洁界面**: 移除了验证码和登录方式选择
- **错误处理**: 完善的错误提示和处理机制
- **自动跳转**: 登录成功后自动跳转到首页

#### 首页 (`pages/home/home.vue`)
- **登录状态检查**: 自动检查用户登录状态
- **Token自动刷新**: 在Token即将过期时自动刷新
- **用户信息同步**: 从认证服务获取最新用户信息

#### 个人中心 (`pages/profile/profile.vue`)
- **安全退出**: 使用认证服务进行安全退出
- **用户信息展示**: 显示从后端获取的用户信息

### 3. 更新的工具类

#### API工具 (`utils/simple-api.js`)
- **配置化**: 使用配置文件管理API地址
- **Token自动添加**: 自动在请求头中添加认证Token
- **错误处理**: 统一的HTTP错误处理
- **表单提交**: 支持OAuth2PasswordRequestForm格式

## 🚀 使用方法

### 1. 配置后端地址

编辑 `config/index.js` 文件，设置正确的后端API地址：

```javascript
const API_CONFIG = {
  [ENV.DEVELOPMENT]: {
    BASE_URL: 'http://localhost:8000/api/v1',  // 修改为你的后端地址
    TIMEOUT: 10000,
    RETRY_TIMES: 3
  }
};
```

### 2. 启动后端服务

确保后端服务正在运行：

```bash
# 在后端项目目录下
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

### 3. 测试登录功能

#### 系统用户登录
1. 在登录页面选择"系统登录"
2. 输入系统用户名和密码
3. 输入验证码
4. 点击登录

#### 教务系统直接登录
1. 在登录页面选择"教务系统登录"（默认）
2. 输入教务系统学号和密码
3. 点击登录（无需验证码）

### 4. 快速测试

点击"学生登录"快速按钮，会自动填入测试账号：
- 学号: `2021001001`
- 密码: `123456`
- 登录方式: 教务系统登录

## 🔐 认证流程

### 系统用户登录流程
```
1. 用户输入用户名、密码、验证码
2. 前端验证验证码
3. 调用 POST /api/v1/auth/login (OAuth2PasswordRequestForm)
4. 后端验证用户名密码
5. 返回JWT Token和用户信息
6. 前端保存Token和用户信息
7. 跳转到首页
```

### 教务系统直接登录流程
```
1. 用户输入学号、密码
2. 调用 POST /api/v1/auth/edu-login
3. 后端使用爬虫登录教务系统
4. 获取学生信息
5. 创建或更新系统用户
6. 返回JWT Token和用户信息
7. 前端保存Token和用户信息
8. 跳转到首页
```

## 🛡️ 安全特性

### Token管理
- **自动过期检查**: 检查Token是否即将过期
- **自动刷新**: 在Token过期前自动刷新
- **安全存储**: Token存储在本地安全存储中
- **自动清理**: 退出登录时自动清理所有认证信息

### 错误处理
- **401处理**: Token过期时自动跳转登录页
- **网络错误**: 网络请求失败的友好提示
- **验证码错误**: 验证码错误时自动刷新
- **登录失败**: 详细的登录失败原因提示

## 📱 页面交互

### 登录页面
- **登录方式切换**: 点击切换系统登录/教务系统登录
- **密码显示/隐藏**: 点击眼睛图标切换密码显示
- **验证码刷新**: 点击验证码图片刷新
- **记住密码**: 勾选后保存用户名密码
- **快速登录**: 一键填入测试账号

### 首页
- **自动检查**: 页面加载时自动检查登录状态
- **用户信息**: 显示从后端获取的用户信息
- **Token刷新**: 后台自动刷新即将过期的Token

### 个人中心
- **用户信息**: 显示详细的用户信息
- **安全退出**: 确认后安全退出登录

## 🔧 开发调试

### 启用调试模式

在 `config/index.js` 中设置：

```javascript
const CURRENT_ENV = ENV.DEVELOPMENT;
```

### 查看日志

在浏览器控制台中可以看到详细的日志信息：
- 登录流程日志
- API请求日志
- Token管理日志
- 错误信息日志

### 测试验证码

可以调用验证码服务的测试方法：

```javascript
import captchaService from './services/captcha.js';

// 测试验证码识别
captchaService.testCaptchaRecognition();

// 批量测试验证码准确率
captchaService.batchTestCaptcha(10);
```

## 🚨 注意事项

1. **网络环境**: 确保小程序能够访问后端API地址
2. **CORS配置**: 后端需要正确配置CORS允许小程序域名
3. **HTTPS**: 生产环境建议使用HTTPS
4. **Token安全**: 不要在日志中输出完整的Token
5. **密码安全**: 生产环境不应返回用户密码

## 📞 技术支持

如果在集成过程中遇到问题，请检查：

1. 后端服务是否正常运行
2. API地址配置是否正确
3. 网络连接是否正常
4. 浏览器控制台是否有错误信息

更多技术细节请参考后端API文档：`docs/API接口文档.md`
